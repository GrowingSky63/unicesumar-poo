<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Livro de Receitas (Din√¢mico)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="/static/style.css" />
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2>üìñ Categorias</h2>
    <div id="categorias-list"></div>
    <button id="btn-nova-cat">+ Nova Categoria</button>
  </div>
  <div class="book-container">
    <div class="book">
      <div class="book-page">
        <div class="page-header">
          <h1 class="page-title" id="livro-titulo">Carregando...</h1>
          <p class="page-subtitle" id="livro-autor"></p>
          <button id="btn-nova-receita">+ Nova Receita</button>
        </div>
        <div id="receitas" class="recipes-grid"></div>
      </div>
    </div>
  </div>
</div>
<script>
const API_BASE = 'http://127.0.0.1:5000';
let livroId = null;
let cacheLivro = null;
let categoriaAtiva = 'all';
let formAberto = false;
let unidadesCache = [];
let ingredientesCache = [];

async function ensureLivro(){
  if(livroId) return livroId;
  const resp = await fetch(`${API_BASE}/livros`);
  const lista = await resp.json();
  if(lista.length){
     livroId = lista[0].id;
     return livroId;
  }
  const novo = await fetch(`${API_BASE}/livros`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({titulo:'Meu Livro', autor:'Autor Exemplo'})});
  const data = await novo.json();
  livroId = data.id;
  return livroId;
}

async function carregarLivro(){
  await ensureLivro();
  await carregarUnidades();
  await carregarIngredientesExistentes();
  const resp = await fetch(`${API_BASE}/livros/${livroId}`);
  cacheLivro = await resp.json();
  document.getElementById('livro-titulo').textContent = cacheLivro.titulo;
  document.getElementById('livro-autor').textContent = 'Autor: ' + cacheLivro.autor;
  renderCategorias();
  renderReceitas();
}

async function carregarUnidades(){
  if(unidadesCache.length) return;
  const resp = await fetch(`${API_BASE}/unidades`);
  const data = await resp.json();
  unidadesCache = data.unidades || [];
}

async function carregarIngredientesExistentes(){
  const resp = await fetch(`${API_BASE}/livros/${livroId}/ingredientes`);
  const data = await resp.json();
  ingredientesCache = data.ingredientes || [];
}

function renderCategorias(){
  const cont = document.getElementById('categorias-list');
  cont.innerHTML = '<button class="category-btn'+(categoriaAtiva==='all'?' active':'')+'" data-id="all">Todas</button>';
  cacheLivro.categorias.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'category-btn'+(categoriaAtiva===c.id?' active':'');
    btn.textContent = c.nome;
    btn.dataset.id = c.id;
    btn.onclick = ()=>{categoriaAtiva=c.id; atualizarEstadoCategorias(); filtrarReceitas(c.id);};
    cont.appendChild(btn);
  });
  const allBtn = cont.querySelector('button.category-btn[data-id="all"]');
  if(allBtn){
    allBtn.onclick = ()=>{ categoriaAtiva='all'; atualizarEstadoCategorias(); filtrarReceitas('all'); };
  }
}

function atualizarEstadoCategorias(){
  document.querySelectorAll('.category-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.id===categoriaAtiva);
  });
}

function receitaCard(r){
  const div = document.createElement('div');
  div.className='recipe-card';
  div.innerHTML = `<h3 class="recipe-title">${r.nome}</h3>
    <div class="recipe-ingredients"><h4>Ingredientes:</h4><ul>${r.ingredientes.map(i=>`<li>${i.quantidade} - ${i.nome}</li>`).join('')}</ul></div>
    <div class="recipe-instructions"><h4>Modo:</h4><p>${r.modo_preparo}</p></div>
    <span class="recipe-time">‚è∞ ${r.tempo_preparo} min</span>`;
  return div;
}

function criarFormularioNovaReceita(){
  const card = document.createElement('div');
  card.className = 'recipe-card recipe-form';
  card.innerHTML = `
    <h3>Nova Receita ${categoriaAtiva!=='all'?'<small style="font-weight:normal">(Categoria selecionada)</small>':''}</h3>
    <form id="form-receita">
      <label>Nome*<br><input name="nome" required /></label><br>
      <div class="duo">
        <label>Tempo (min)*<br><input type="number" name="tempo" required min="1" value="30" /></label>
        <label>Rendimento*<br><input name="rendimento" required value="1 por√ß√£o" /></label>
      </div>
      <label>Modo de Preparo*<br><textarea name="modo" rows="4" required></textarea></label>
      <fieldset class="ingredientes-field">
        <legend>Ingredientes</legend>
        <div id="lista-ingredientes"></div>
        <button type="button" id="btn-add-ing">+ Ingrediente</button>
      </fieldset>
      <div class="acoes">
        <button type="submit">Salvar</button>
        <button type="button" id="btn-cancelar">Cancelar</button>
      </div>
    </form>`;

  // Fun√ß√µes de ingredientes
  const lista = card.querySelector('#lista-ingredientes');
  function adicionarLinha(qtd='', unidade='', nome=''){
     const row = document.createElement('div');
     row.className='ing-row';
     const unidadesOptions = unidadesCache.map(u=>`<option value="${u}"></option>`).join('');
     const ingredientesOptions = ingredientesCache.map(i=>`<option value="${i}"></option>`).join('');
     row.innerHTML = `
       <input placeholder="Qtd" class="ing-qtd" value="${qtd}" style="width:60px" />
       <input list="lista-unidades" placeholder="Unid" class="ing-unid" value="${unidade}" style="width:80px" />
       <input list="lista-ingredientes" placeholder="Nome do ingrediente" class="ing-nome" value="${nome}" />
       <button type="button" class="rem">‚úï</button>
       <datalist id="lista-unidades">${unidadesOptions}</datalist>
       <datalist id="lista-ingredientes">${ingredientesOptions}</datalist>`;
     row.querySelector('.rem').onclick = ()=>{ row.remove(); };
     lista.appendChild(row);
  }
  adicionarLinha();
  card.querySelector('#btn-add-ing').onclick = ()=>adicionarLinha();

  card.querySelector('#btn-cancelar').onclick = ()=>{
     formAberto = false;
     card.remove();
  };

  card.querySelector('#form-receita').onsubmit = async (e)=>{
     e.preventDefault();
     const fd = new FormData(e.target);
     const nome = fd.get('nome').toString().trim();
     const tempo = fd.get('tempo').toString();
     const rendimento = fd.get('rendimento').toString();
     const modo = fd.get('modo').toString();
     const ingRows = Array.from(lista.querySelectorAll('.ing-row'));
     const ingredientes = ingRows.map(r=>{
        const q = r.querySelector('.ing-qtd').value.trim();
        const u = r.querySelector('.ing-unid').value.trim();
        const n = r.querySelector('.ing-nome').value.trim();
        if(!n) return null;
        const quantidade = (q && u) ? `${q} ${u}` : (q? q : '1 unit');
        return {nome:n, quantidade};
     }).filter(Boolean);
     if(!nome || !modo){ alert('Preencha os campos obrigat√≥rios.'); return; }
     const url = new URL(`${API_BASE}/livros/${livroId}/receitas`);
     if(categoriaAtiva !== 'all') url.searchParams.set('categoria_id', categoriaAtiva);
     const resp = await fetch(url.toString(), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({nome, modo_preparo:modo, tempo_preparo:tempo, rendimento, ingredientes})});
     if(!resp.ok){
        const err = await resp.text();
        alert('Erro ao salvar: '+err);
        return;
     }
     formAberto = false;
     await carregarLivro();
     atualizarEstadoCategorias();
     filtrarReceitas(categoriaAtiva);
  };
  return card;
}

function renderReceitas(lista){
  const alvo = document.getElementById('receitas');
  alvo.innerHTML='';
  (lista || cacheLivro.receitas).forEach(r=>alvo.appendChild(receitaCard(r)));
}

function filtrarReceitas(catId){
  if(catId==='all'){ renderReceitas(); return; }
  const cat = cacheLivro.categorias.find(c=>c.id===catId);
  if(!cat){return;}
  const ids = new Set(cat.receitas);
  const filtradas = cacheLivro.receitas.filter(r=>ids.has(r.id));
  renderReceitas(filtradas);
}

document.getElementById('btn-nova-cat').onclick = async ()=>{
  const nome = prompt('Nome da categoria:');
  if(!nome) return;
  await fetch(`${API_BASE}/livros/${livroId}/categorias`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({nome})});
  carregarLivro();
};

document.getElementById('btn-nova-receita').onclick = async ()=>{
  if(formAberto) return; // evita m√∫ltiplos
  formAberto = true;
  const container = document.getElementById('receitas');
  const formCard = criarFormularioNovaReceita();
  container.prepend(formCard);
  formCard.scrollIntoView({behavior:'smooth'});
};

carregarLivro();
</script>
</body>
</html>
